# GENERATED BY LSXTOOL — No editar manualmente; regenerar desde estado declarativo.

# --- LSX META ---
# server_web: nginx
# server_web_version: 1.26.3
# environment: dev
# provider: lunarsystemx
# role: frontend
# root.path: /mnt/d/www/00-LSX/100-projects/demos/php/frontend
# owner: equipo-identity
# technical_user: michael.carrillo
# --- END META ---

# --- Canary split: api__demo ---
split_clients "$request_id" $api_demo_bucket_sc {
    50%     canary;
    *       base;
}

# --- Canary map (cookie): api__demo ---
map $cookie_lsx_demo_canary $api_demo_bucket {
    default $api_demo_bucket_sc;
    "base" base;
    "canary" canary;
}

upstream api__demo_base {
    server 172.20.70.169:8072;
}

upstream api__demo_canary {
    server 172.20.70.169:8074 weight=75;
    server 172.20.70.169:8082 weight=25;
}

upstream api__identity {
    server 192.168.20.234:3001;
}

upstream frontend__php_demo {
    server 172.20.70.169:8010;
}

server {
    listen 9100;
    listen [::]:9100;
    server_name dev-identity.lunarsystemx.com;

    # Root declarado para ownership y permisos
    # No se utiliza contenido estático en este servicio
    # root /mnt/d/www/00-LSX/100-projects/demos/php/frontend;

    access_log /var/log/lunarsystemx/dev/identity/access.log;
    error_log /var/log/lunarsystemx/dev/identity/error.log;

    # Route: api_identity
    location /api/identity/ {
        rewrite ^\/api\/identity/?(.*)$ /$1 break;
        proxy_pass http://api__identity;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Route: api_demo
    location /api/demo/ {
        rewrite ^\/api\/demo/?(.*)$ /$1 break;
        proxy_pass http://api__demo_$api_demo_bucket;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-LSX-Canary $api_demo_bucket;
        add_header Set-Cookie "lsx_demo_canary=$api_demo_bucket; Path=/; Max-Age=86400" always;
    }

    # Route: root
    location / {
        proxy_pass http://frontend__php_demo/;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

}